<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feedback Form</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/styles/styles.css">
  
  <!-- Load Firebase first -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <!-- Then load Konva (required for certificate generation) -->
  <script src="https://cdn.jsdelivr.net/npm/konva@9.2.0/konva.min.js"></script>
  
  <!-- Finally load the certificate generator (with defer to ensure it loads after Konva) -->
  <script src="./script/certificate-generator.js" defer></script>
</head>

<body class="bg-gradient-to-tr from-[#000000] from-35% to-[#00691c] min-h-screen flex justify-center items-center p-4 h-screen overflow-hidden">
  <div class="glass max-w-2xl w-full rounded-xl h-full p-8 shadow-lg overflow-hidden flex flex-col">
    
    <div class="mb-3">
      <img src="/images/inttoLogo.png" alt="into logo" class="h-16 w-auto">
      <div class="text-xs text-white mt-1">Innovation & Technology Transfer Office</div>
    </div>

    <div class="overflow-y-auto">
           
      <!-- Event details section -->
      <div class="mb-6 bg-black/40 rounded-xl p-6 border-l-[6px] border-l-[#3be382]">
        <h1 id="eventTitle" class="text-2xl font-bold text-white mb-2">Event Feedback Form</h1>
        <div class="max-h-20 overflow-auto custom-scrollbar">
          <p id="eventDescription" class="text-gray-200 text-sm mb-1 break-words whitespace-pre-wrap"></p>
        </div>
        <p id="eventDetails" class="text-gray-300 text-xs italic mt-3"></p>
      </div>
      
      <div class="flex-grow custom-scrollbar" style="max-height: calc(100% - 180px);">
        <!-- Name Input Field in Card -->
        <div class="mb-6 bg-black/30 rounded-xl p-6 shadow-lg border border-gray-700">
          <label for="participantName" class="block text-white text-lg font-bold mb-3">Your Name</label>
          <input type="text" id="participantName" class="w-full p-3 border border-gray-400 rounded-xl shadow-lg bg-transparent text-white placeholder-gray-400" placeholder="Enter your full name" required>
        </div>
        
        <form id="feedbackForm" class="space-y-6">
          <div id="questionsContainer" class="space-y-6">
            <!-- Loading indicator -->
            <div class="flex justify-center items-center p-8">
              <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-[#3be382]"></div>
            </div>
            <!-- Questions will be inserted here dynamically -->
          </div>
        </form>
      </div>
    </div>
    <!-- Button container fixed at bottom with proper padding -->
    <div class="pt-6 pb-2 mt-auto">
      <div class="flex justify-center">
        <button type="submit" id="submitBtn" form="feedbackForm" class="bg-[#232b2b] border border-[#3be382] text-white font-bold px-8 py-3 rounded-xl hover:bg-[#1a1a1a] transition shadow-lg w-full md:w-auto">
          Submit Feedback
        </button>
      </div>
    </div>
    
    <!-- Thank you message -->
    <div id="thankYouMessage" class="hidden text-center">
      <h2 class="text-2xl font-bold text-[#3be382] mb-4">Thank You!</h2>
      <p class="text-white mb-6">Your feedback has been submitted successfully.</p>
      <button id="downloadCertBtn" class="bg-[#232b2b] border border-[#3be382] text-white font-bold px-8 py-3 rounded-xl hover:bg-[#1a1a1a] transition">
        Download Certificate
      </button>
      <p id="certStatus" class="text-sm text-white mt-2"></p>
    </div>

    <!-- Hidden certificate container -->
    <div id="certificateContainer" class="hidden"></div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC92G1LybSWu3463j1Wi0yjZaTzuiHcIMk",
      authDomain: "autocert-8319d.firebaseapp.com",
      projectId: "autocert-8319d",
      storageBucket: "autocert-8319d.firebasestorage.app",
      messagingSenderId: "941021055631",
      appId: "1:941021055631:web:ffbfae2bce3856f742fefa",
      measurementId: "G-Q7Z8VF2N2W"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Get event name from URL
    const params = new URLSearchParams(window.location.search);
    const eventName = params.get('event') || '';
    
    // DOM elements - Define form early to avoid the "form is not defined" error
    const form = document.getElementById('feedbackForm');
    const questionsContainer = document.getElementById('questionsContainer');
    const thankYouMessage = document.getElementById('thankYouMessage');
    const downloadCertBtn = document.getElementById('downloadCertBtn');
    const participantNameInput = document.getElementById('participantName');
    const certStatus = document.getElementById('certStatus');
    
    // Store event data globally
    let eventData = null;
    
    // Update event details in the UI
    function updateEventDetails(eventData) {
      // Set event title
      document.getElementById('eventTitle').textContent = eventName || 'Event Feedback Form';
      
      // Set event description (if available)
      const description = document.getElementById('eventDescription');
      if (eventData && eventData.description) {
        description.textContent = eventData.description;
      } else {
        description.textContent = "This form is for the attendees of the event. This is meant to take note of the attendance of those who attended, as well as provide feedback for the services of the Innovation and Technology Transfer Office, as well as the program itself. This form shall also be used to determine those who will be getting certificates.";
      }
      
      // Set event details
      const details = document.getElementById('eventDetails');
      details.textContent = "Please complete this form to provide your feedback.";
    }
    
    // Check if certificate generator is loaded
    function checkCertificateGenerator() {
      const generatorLoaded = window.CertificateGenerator && typeof window.CertificateGenerator.generate === 'function';
      const statusText = document.getElementById('certStatus');
      
      if (generatorLoaded) {
        statusText.textContent = "Certificate generator is ready.";
        return true;
      } else {
        statusText.textContent = "Waiting for certificate generator to load...";
        return false;
      }
    }
    
    // Load questions from Firestore
    async function loadQuestions() {
        if (!eventName) {
            questionsContainer.innerHTML = '<div class="bg-black/30 rounded-xl p-6 shadow-lg border border-red-500"><p class="text-red-500">Error: No event specified</p></div>';
            return;
        }
        
        try {
            const doc = await db.collection("events").doc(eventName).get();
            if (!doc.exists) {
                questionsContainer.innerHTML = '<div class="bg-black/30 rounded-xl p-6 shadow-lg border border-red-500"><p class="text-red-500">Event not found</p></div>';
                return;
            }
            
            // Check if form has expired
            const currentEventData = doc.data();
            const expiresAt = currentEventData.expiresAt ? new Date(currentEventData.expiresAt) : null;
            const now = new Date();
            
            // Update event details in UI
            updateEventDetails(currentEventData);
            
            if (expiresAt && now > expiresAt) {
                questionsContainer.innerHTML = '<div class="bg-black/30 rounded-xl p-6 shadow-lg border border-red-500"><p class="text-red-500">This feedback form has expired</p></div>';
                // Hide form elements
                document.getElementById('participantName').parentElement.classList.add('hidden');
                document.getElementById('submitBtn').classList.add('hidden');
                return;
            }
            
            eventData = currentEventData;
            const questions = eventData.questions || [];
            
            if (questions.length === 0) {
              questionsContainer.innerHTML = '<div class="bg-black/30 rounded-xl p-6 shadow-lg border border-yellow-500"><p class="text-yellow-500">No questions found for this event</p></div>';
              return;
            }
            
            // Clear loading spinner
            questionsContainer.innerHTML = '';
            
            // Add questions to the form - each in its own card
            questions.forEach((q, index) => {
              // Create card container for this question
              const questionCard = document.createElement('div');
              questionCard.className = 'bg-black/30 rounded-xl p-6 shadow-lg border border-gray-700';
              questionCard.id = `question_card_${index}`;
              
              // Add question number
              const questionNumber = document.createElement('div');
              questionNumber.className = 'text-[#3be382] text-sm font-semibold mb-1';
              questionNumber.textContent = `Question ${index + 1}`;
              questionCard.appendChild(questionNumber);
              
              // Create question label
              const label = document.createElement('label');
              label.className = 'block text-white text-lg font-bold mb-4';
              label.textContent = q.text;
              label.setAttribute('for', `question_${index}`);
              questionCard.appendChild(label);
              
              if (q.type === 'rating') {
                // Create rating scale (1-5)
                const ratingDiv = document.createElement('div');
                ratingDiv.className = 'flex justify-between items-center gap-1 px-8';
                
                for (let i = 1; i <= 5; i++) {
                  const ratingGroup = document.createElement('div');
                  ratingGroup.className = 'flex flex-col items-center';
                  
                  const radio = document.createElement('input');
                  radio.type = 'radio';
                  radio.name = `question_${index}`;
                  radio.value = i;
                  radio.id = `question_${index}_rating_${i}`;
                  radio.className = 'form-radio h-6 w-6 text-[#3be382] cursor-pointer';
                  radio.required = true;
                  
                  const ratingLabel = document.createElement('label');
                  ratingLabel.htmlFor = `question_${index}_rating_${i}`;
                  ratingLabel.className = 'text-white text-sm mt-2 cursor-pointer';
                  ratingLabel.textContent = i;
                  
                  ratingGroup.appendChild(radio);
                  ratingGroup.appendChild(ratingLabel);
                  ratingDiv.appendChild(ratingGroup);
                }
                
                questionCard.appendChild(ratingDiv);
                
                // Add rating scale labels
                const ratingLabels = document.createElement('div');
                ratingLabels.className = 'flex justify-between text-xs text-gray-400 mt-2 px-6';
                ratingLabels.innerHTML = '<span>Poor</span><span>Excellent</span>';
                questionCard.appendChild(ratingLabels);
                
              } else if (q.type === 'textarea') {
                // Create text area for longer responses
                const textarea = document.createElement('textarea');
                textarea.id = `question_${index}`;
                textarea.name = `question_${index}`;
                textarea.rows = 3;
                textarea.className = 'w-full p-3 border border-gray-400 rounded-xl shadow-lg bg-transparent text-white placeholder-gray-400 focus:border-[#3be382]';
                textarea.required = true;
                
                questionCard.appendChild(textarea);
              } else {
                // Create text input (default)
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `question_${index}`;
                input.name = `question_${index}`;
                input.className = 'w-full p-3 border border-gray-400 rounded-xl shadow-lg bg-transparent text-white placeholder-gray-400 focus:border-[#3be382]';
                input.required = true;
                
                questionCard.appendChild(input);
              }
              
              // Add the card to the container
              questionsContainer.appendChild(questionCard);
            });
        } catch (error) {
            console.error("Error loading questions:", error);
            questionsContainer.innerHTML = `<div class="bg-black/30 rounded-xl p-6 shadow-lg border border-red-500"><p class="text-red-500">Error loading questions: ${error.message}</p></div>`;
        }
    }
    
    // Form submission handler
    document.getElementById('submitBtn').addEventListener('click', async function() {
      // Check if form is valid
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const participantName = participantNameInput.value.trim();
      if (!participantName) {
        alert("Please enter your name");
        return;
      }
      
      // Collect responses
      const responses = [];
      const questions = eventData.questions || [];
      
      questions.forEach((q, index) => {
        if (q.type === 'rating') {
          const selectedRating = document.querySelector(`input[name="question_${index}"]:checked`);
          if (selectedRating) {
            responses.push({
              question: q.text,
              answer: selectedRating.value,
              type: q.type
            });
          }
        } else {
          const input = document.getElementById(`question_${index}`);
          if (input && input.value) {
            responses.push({
              question: q.text,
              answer: input.value,
              type: q.type || 'text'
            });
          }
        }
      });
      
      // Save responses to Firestore
      try {
        await db.collection("events").doc(eventName).collection("responses").add({
          participantName,
          responses,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Hide form, show thank you message
        form.classList.add('hidden');
        participantNameInput.parentElement.classList.add('hidden');
        document.getElementById('submitBtn').classList.add('hidden');
        thankYouMessage.classList.remove('hidden');
      } catch (error) {
        console.error("Error submitting feedback:", error);
        alert("Error submitting feedback. Please try again.");
      }
    });
    
    // Remove the existing submit handler from the form to avoid double submission
    form.addEventListener('submit', function(e) {
      e.preventDefault(); // Just prevent default, actual submission is handled by button click
    });
    
    // Certificate download handler
    downloadCertBtn.addEventListener('click', async function() {
      certStatus.textContent = "Generating your certificate...";
      downloadCertBtn.disabled = true;
      
      try {
        // Ensure certificate generator is loaded
        if (!checkCertificateGenerator()) {
          throw new Error("Certificate generator not available. Please try again later.");
        }
        
        // Get the latest event data
        const eventDoc = await db.collection("events").doc(eventName).get();
        if (!eventDoc.exists) {
          throw new Error("Event not found");
        }
        
        const updatedEventData = eventDoc.data();
        console.log("Retrieved event data:", updatedEventData);
        
        // Verify we have the necessary data
        if (!updatedEventData.certificateUrl) {
          throw new Error("Certificate template not configured");
        }
        
        if (!updatedEventData.namePlacement) {
          throw new Error("Certificate name placement not configured");
        }
        
        const participantName = participantNameInput.value.trim();
        
        // Generate the certificate
        const certificateDataURL = await window.CertificateGenerator.generate({
          certificateUrl: updatedEventData.certificateUrl,
          namePlacement: updatedEventData.namePlacement,
          participantName: participantName
        });
        
        // Download the certificate
        window.CertificateGenerator.download(certificateDataURL, `${eventName}-certificate.jpg`);
        
        certStatus.textContent = "Certificate downloaded!";
        downloadCertBtn.textContent = "Download Again";
        downloadCertBtn.disabled = false;
        
      } catch (error) {
        console.error("Error generating certificate:", error);
        certStatus.textContent = `Error: ${error.message}`;
        downloadCertBtn.disabled = false;
      }
    });
    
    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Re-assign form variable to ensure it's available after DOM is loaded
      const refreshedForm = document.getElementById('feedbackForm');
      if (refreshedForm && !form) {
        form = refreshedForm;
      }
      
      loadQuestions();
      
      // Check dependencies
      if (typeof Konva === 'undefined') {
        console.error("Konva library not loaded!");
      }
      
      // Wait a bit for the certificate generator to load
      setTimeout(checkCertificateGenerator, 1000);
    });
  </script>
</body>
</html>